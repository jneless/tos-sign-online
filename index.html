<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOS 签名计算器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            /* AWS控制台扁平化设计颜色系统 */
            --aws-blue: #232f3e;
            --aws-orange: #ff9900;
            --aws-light-blue: #146eb4;
            --aws-gray-50: #fafafa;
            --aws-gray-100: #f2f3f3;
            --aws-gray-200: #eaeded;
            --aws-gray-300: #d5dbdb;
            --aws-gray-400: #aab7b8;
            --aws-gray-500: #85929e;
            --aws-gray-600: #5d6d7e;
            --aws-gray-700: #34495e;
            --aws-gray-800: #2c3e50;
            --aws-gray-900: #1b2631;
            --aws-white: #ffffff;
            --aws-red: #d13212;
            --aws-green: #037f0c;
            --aws-border: #d5dbdb;
            --aws-focus: #0073bb;
            --aws-hover: #f2f3f3;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Amazon Ember', 'Helvetica Neue', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--aws-gray-50);
            color: var(--aws-gray-800);
            line-height: 1.5;
            font-size: 14px;
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            background: var(--aws-white);
            border: 1px solid var(--aws-border);
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .info-banner {
            background: #e7f3ff;
            border: 1px solid var(--aws-light-blue);
            border-radius: 4px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--aws-gray-700);
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-banner a {
            color: var(--aws-light-blue);
            text-decoration: none;
            font-weight: 600;
        }

        .info-banner a:hover {
            text-decoration: underline;
        }

        .info-banner-close {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 16px;
            color: var(--aws-gray-500);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            border-radius: 2px;
        }

        .info-banner-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--aws-gray-700);
        }

        .page-title {
            margin: 0;
            font-size: 28px;
            font-weight: 400;
            color: var(--aws-gray-900);
            line-height: 1.2;
        }

        .page-subtitle {
            margin: 8px 0 0;
            color: var(--aws-gray-600);
            font-size: 14px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-panel {
            background: var(--aws-white);
            border: 1px solid var(--aws-border);
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .results-panel {
            background: var(--aws-white);
            border: 1px solid var(--aws-border);
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .form-section {
            padding: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--aws-gray-900);
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--aws-gray-200);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .flowchart-section {
            background: var(--aws-white);
            border: 1px solid var(--aws-border);
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--aws-gray-700);
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--aws-border);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--aws-white);
            color: var(--aws-gray-800);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--aws-focus);
            box-shadow: 0 0 0 2px rgba(0, 115, 187, 0.2);
        }

        .form-textarea {
            height: 80px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .form-help {
            font-size: 12px;
            color: var(--aws-gray-500);
            margin-top: 4px;
        }

        .method-warning {
            font-size: 12px;
            color: var(--aws-red);
            background-color: #ffeaea;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 8px;
            font-weight: 600;
        }

        .host-process-info {
            font-size: 12px;
            color: var(--aws-green);
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            position: relative;
        }

        .host-process-info .original-url {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: rgba(76, 175, 80, 0.1);
            padding: 4px 6px;
            border-radius: 3px;
            word-break: break-all;
            margin-bottom: 6px;
            display: block;
            font-weight: 500;
        }

        .host-process-info .process-details {
            font-weight: 600;
        }

        .host-process-close {
            position: absolute;
            right: 8px;
            top: 8px;
            background: none;
            border: none;
            color: var(--aws-green);
            font-size: 14px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 2px;
            line-height: 1;
            font-weight: bold;
        }

        .host-process-close:hover {
            background-color: rgba(76, 175, 80, 0.2);
        }

        .expandable-section {
            border: 1px solid var(--aws-border);
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .expandable-header {
            background-color: var(--aws-gray-100);
            padding: 12px 16px;
            border-bottom: 1px solid var(--aws-border);
            font-weight: 600;
            color: var(--aws-gray-700);
        }

        .expandable-content {
            padding: 16px;
            background-color: var(--aws-white);
        }

        .param-row {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            align-items: center;
        }

        .param-row .form-input {
            flex: 1;
            margin: 0;
        }

        .btn {
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--aws-orange);
            color: var(--aws-white);
            border: 1px solid var(--aws-orange);
        }

        .btn-primary:hover {
            background-color: #e88400;
            border-color: #e88400;
        }

        .btn-secondary {
            background-color: var(--aws-white);
            color: var(--aws-gray-700);
            border: 1px solid var(--aws-border);
        }

        .btn-secondary:hover {
            background-color: var(--aws-hover);
        }

        .btn-danger {
            background-color: var(--aws-red);
            color: var(--aws-white);
            border: 1px solid var(--aws-red);
        }

        .btn-danger:hover {
            background-color: #b02a0c;
            border-color: #b02a0c;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-full {
            width: auto;
            padding: 12px 32px;
            font-size: 16px;
            margin-top: 24px;
        }

        .results-container {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .results-panel {
            background: var(--aws-white);
            border: 1px solid var(--aws-border);
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background-color: var(--aws-gray-100);
            padding: 16px 20px;
            border-bottom: 1px solid var(--aws-border);
            font-size: 16px;
            font-weight: 600;
            color: var(--aws-gray-900);
        }

        .panel-content {
            padding: 0;
        }

        .flowchart-container {
            padding: 20px;
            text-align: center;
            background-color: var(--aws-white);
        }

        .output-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--aws-gray-200);
        }

        .output-item:last-child {
            border-bottom: none;
        }

        .output-label {
            font-weight: 600;
            color: var(--aws-gray-700);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .output-value {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: var(--aws-gray-50);
            padding: 12px;
            border-radius: 4px;
            border: 1px solid var(--aws-border);
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 12px;
            color: var(--aws-gray-800);
            line-height: 1.4;
        }

        .notification {
            background-color: #d4efe7;
            border: 1px solid var(--aws-green);
            color: #0f5132;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }

        .node-details {
            background-color: #e7f3ff;
            border: 1px solid var(--aws-light-blue);
            border-radius: 4px;
            padding: 16px;
            margin: 16px 20px 20px;
            display: none;
            text-align: left;
        }

        .node-details h4 {
            margin: 0 0 12px 0;
            color: var(--aws-gray-800);
            font-size: 16px;
            font-weight: 600;
        }

        .node-details pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            color: var(--aws-gray-700);
            background: none;
            border: none;
            padding: 0;
        }

        .timestamp-info {
            font-size: 12px;
            color: var(--aws-gray-500);
            margin-top: 4px;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--aws-gray-100);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--aws-gray-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--aws-gray-500);
        }

        /* 表格样式优化 */
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--aws-border);
        }

        .data-table th {
            background-color: var(--aws-gray-100);
            font-weight: 600;
            color: var(--aws-gray-700);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="info-banner" id="info-banner">
            <span>如有bug，欢迎前往 <a href="https://github.com/jneless/tos-sign-online" target="_blank">https://github.com/jneless/tos-sign-online</a> 提issue</span>
            <button class="info-banner-close" onclick="closeInfoBanner()" title="关闭">×</button>
        </div>
        
        <div class="page-header">
            <h1 class="page-title">TOS 签名计算器</h1>
            <p class="page-subtitle">在线计算 TOS API 签名，单页应用，纯前端 javascript 运行</p>
            <p class="page-subtitle">采用 Github + Vercel 自动化构建，源码在Github可见，不会保存AK/SK</p>
        </div>
        
        <div class="main-layout">
            <!-- 左侧输入面板 -->
            <div class="input-panel">
                <div class="form-section">
                    <div id="notification" class="notification"></div>
                    
                    <form id="signatureForm">
                        <div class="section-title">基础配置</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="accessKey">Access Key</label>
                                <input class="form-input" type="text" id="accessKey" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="secretKey">Secret Key</label>
                                <input class="form-input" type="text" id="secretKey" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="region">Region</label>
                                <input class="form-input" type="text" id="region" value="cn-beijing" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="service">Service</label>
                                <input class="form-input" type="text" id="service" value="tos" required>
                                <div class="form-help">默认为 tos</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="host">Host</label>
                                <input class="form-input" type="text" id="host" placeholder="example.tos-cn-beijing.volces.com" required onblur="processHostInput()">
                                <div class="form-help">通常是 tos-${region}.volces.com 或者是 ${bucketname}.tos-${region}.volces.com 的形式，忽略http或https的前缀，结尾不含/</div>
                                <div id="hostProcessInfo" class="host-process-info" style="display: none;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="path">Path</label>
                                <input class="form-input" type="text" id="path" value="/" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="method">HTTP Method</label>
                                <select class="form-select" id="method" required onchange="checkMethodBodyConflict()">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                    <option value="HEAD">HEAD</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="requestBody">Request Body</label>
                                <textarea class="form-textarea" id="requestBody" placeholder="请求体内容（JSON等）" oninput="checkMethodBodyConflict()"></textarea>
                                <div id="methodBodyWarning" class="method-warning" style="display: none;">
                                    ⚠️ 当前Method为GET，请仔细检查
                                </div>
                            </div>
                        </div>

                        <div class="section-title">时间戳配置</div>
                        <div class="form-group">
                            <label class="form-label" for="timestampType">时间戳输入方式</label>
                            <select class="form-select" id="timestampType" onchange="toggleTimestampInput()">
                                <option value="current">使用当前时间</option>
                                <option value="datetime">选择日期时间</option>
                                <option value="direct">直接输入TOS格式</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="datetimeInput" style="display: none;">
                            <label class="form-label" for="customTimestamp">选择日期时间</label>
                            <input class="form-input" type="datetime-local" id="customTimestamp" 
                                   step="1"
                                   title="支持精确到秒">
                        </div>
                        
                        <div class="form-group" id="directInput" style="display: none;">
                            <label class="form-label" for="directTimestamp">TOS时间戳格式</label>
                            <input class="form-input" type="text" id="directTimestamp" 
                                   placeholder="20250812T142648Z"
                                   pattern="[0-9]{8}T[0-9]{6}Z"
                                   title="格式: YYYYMMDDTHHMMSSZ">
                            <div class="form-help">格式: YYYYMMDDTHHMMSSZ</div>
                        </div>

                        <div class="section-title">Query Parameters (可选)</div>
                        <div class="expandable-section">
                            <div class="expandable-header">查询参数</div>
                            <div class="expandable-content">
                                <div id="queryParams">
                                    <div class="param-row">
                                        <input class="form-input param-key" type="text" placeholder="参数名">
                                        <input class="form-input param-value" type="text" placeholder="参数值">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeParam(this)">删除</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="addParam()">添加参数</button>
                                <div class="form-help">默认为空，如不需要可以不填</div>
                            </div>
                        </div>

                        <div class="section-title">Custom Headers (可选)</div>
                        <div class="expandable-section">
                            <div class="expandable-header">自定义Headers</div>
                            <div class="expandable-content">
                                <div id="customHeaders">
                                    <div class="param-row">
                                        <input class="form-input header-key" type="text" placeholder="Header Name (如: x-tos-meta-example)">
                                        <input class="form-input header-value" type="text" placeholder="Header Value">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeHeader(this)">删除</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="addHeader()">添加Header</button>
                                <div class="form-help">自动包含必需的 headers: host, x-tos-date, x-tos-content-sha256</div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-full">计算签名</button>
                    </form>
                </div>
            </div>
            
            <!-- 右侧结果面板 -->
            <div class="results-panel" id="results-panel" style="display: none;">
                <div class="panel-header">签名计算过程</div>
                <div class="panel-content">
                    <div class="output-item">
                        <div class="output-label">1. 基础参数</div>
                        <div class="output-value" id="basicParamsOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">2. 时间戳处理</div>
                        <div class="output-value" id="timestampOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">3. Payload Hash 计算</div>
                        <div class="output-value" id="payloadHashOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">4. Query Parameters 处理</div>
                        <div class="output-value" id="queryParamsOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">5. Headers 处理</div>
                        <div class="output-value" id="headersToSignOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">6. Canonical Request 构造</div>
                        <div class="output-value" id="canonicalRequestOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">7. String To Sign 构造</div>
                        <div class="output-value" id="stringToSignOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">8. 密钥派生过程</div>
                        <div class="output-value" id="keyDerivationOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">9. 最终签名</div>
                        <div class="output-value" id="signatureOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">10. Authorization Header</div>
                        <div class="output-value" id="authHeaderOutput"></div>
                    </div>
                    
                    <div class="output-item">
                        <div class="output-label">11. 完整的 cURL 请求</div>
                        <div class="output-value" id="curlRequestOutput"></div>
                        <div style="margin-top: 8px;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyCurl()" id="copyCurlBtn">复制 cURL 命令</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 底部流程图区域 -->
        <div class="flowchart-section" id="flowchart-section" style="display: none;">
            <div class="panel-header">TOS 签名计算流程图</div>
            <div class="panel-content">
                <div class="flowchart-container">
                    <div class="mermaid" id="signature-flowchart">
                        <!-- 流程图将在这里渲染 -->
                    </div>
                    <div id="node-details" class="node-details">
                        <strong>节点详细信息</strong>
                        <div id="node-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 关闭信息横幅
        function closeInfoBanner() {
            document.getElementById('info-banner').style.display = 'none';
        }

        // 等待页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 确保 Mermaid 正确初始化
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true,
                        curve: 'cardinal'
                    }
                });
            }
        });

        // 存储节点详细信息
        let nodeDetails = {};
        let chartId = 0; // 用于生成唯一ID

        // 生成流程图
        function generateFlowchart(data) {
            // 安全地转义Mermaid字符串，避免语法错误
            function safeMermaidText(text) {
                if (!text) return '';
                return text.toString()
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/\\/g, '\\\\')
                    .replace(/\n/g, ' ')
                    .replace(/\r/g, ' ')
                    .substring(0, 50); // 限制长度
            }
            
            const flowchartDefinition = `
flowchart TD
    %% 输入参数
    A1["Access Key<br/>${data.accessKey ? safeMermaidText(data.accessKey.substring(0, 8)) + '...' : 'N/A'}"]
    A2["Secret Key<br/>[已提供]"]
    A3["Region<br/>${safeMermaidText(data.region)}"]
    A4["Service<br/>${safeMermaidText(data.service)}"]
    A5["HTTP Method<br/>${safeMermaidText(data.method)}"]
    A6["Host<br/>${safeMermaidText(data.host)}"]
    A7["Path<br/>${safeMermaidText(data.path)}"]
    A8["Request Body<br/>${data.requestBody ? (data.requestBody.length > 15 ? safeMermaidText(data.requestBody.substring(0, 15)) + '...' : safeMermaidText(data.requestBody)) : '空'}"]
    
    %% 时间戳处理
    B1{"生成时间戳"}
    B2["AMZ Date<br/>${safeMermaidText(data.amzDate)}"]
    B3["Date Stamp<br/>${safeMermaidText(data.dateStamp)}"]
    
    %% Payload Hash 计算
    C1{"计算 SHA256"}
    C2["Payload Hash<br/>${data.payloadHash ? safeMermaidText(data.payloadHash.substring(0, 16)) + '...' : 'N/A'}"]
    
    %% Query String 处理
    D1{"规范化查询参数"}
    D2["Canonical Query<br/>${safeMermaidText(data.canonicalQueryString || '空')}"]
    
    %% Headers 处理
    E1{"收集 Headers"}
    E2["Host Header<br/>host:${safeMermaidText(data.host)}"]
    E3["Date Header<br/>x-tos-date:${safeMermaidText(data.amzDate)}"]
    E4["Content Header<br/>x-tos-content-sha256:${data.payloadHash ? safeMermaidText(data.payloadHash.substring(0, 12)) + '...' : 'N/A'}"]
    E5{"排序 Headers"}
    E6["Signed Headers<br/>${safeMermaidText(data.signedHeaders)}"]
    E7["Canonical Headers<br/>${data.canonicalHeaders ? (data.canonicalHeaders.split('\n').length - 1) + ' headers' : '0 headers'}"]
    
    %% Canonical Request 构造
    F1{"构造 Canonical Request"}
    F2["Canonical Request<br/>[Method + URI + Query + Headers + Hash]"]
    F3{"SHA256 Hash"}
    F4["Request Hash<br/>${data.hashCR ? safeMermaidText(data.hashCR.substring(0, 16)) + '...' : 'N/A'}"]
    
    %% String To Sign 构造
    G1{"构造 String To Sign"}
    G2["Credential Scope<br/>${safeMermaidText(data.credentialScope)}"]
    G3["String To Sign<br/>[Algorithm + Date + Scope + Hash]"]
    
    %% 密钥派生
    H1{"HMAC-SHA256<br/>DateStamp, SecretKey"}
    H2["kDate<br/>[中间密钥1]"]
    H3{"HMAC-SHA256<br/>Region, kDate"}
    H4["kRegion<br/>[中间密钥2]"]
    H5{"HMAC-SHA256<br/>Service, kRegion"}
    H6["kService<br/>[中间密钥3]"]
    H7{"HMAC-SHA256<br/>request, kService"}
    H8["kSigning<br/>${data.kSigning ? safeMermaidText(data.kSigning.substring(0, 16)) + '...' : 'N/A'}"]
    
    %% 最终签名
    I1{"HMAC-SHA256<br/>StringToSign, kSigning"}
    I2["Final Signature<br/>${data.signature ? safeMermaidText(data.signature.substring(0, 16)) + '...' : 'N/A'}"]
    
    %% Authorization Header
    J1{"构造 Authorization"}
    J2["Authorization Header<br/>TOS4-HMAC-SHA256 Credential=..."]
    
    %% 连接关系
    %% 时间戳流
    B1 --> B2
    B1 --> B3
    
    %% Payload Hash 流
    A8 --> C1
    C1 --> C2
    
    %% Query 流
    D1 --> D2
    
    %% Headers 流
    A6 --> E2
    B2 --> E3
    C2 --> E4
    E1 --> E2
    E1 --> E3  
    E1 --> E4
    E2 --> E5
    E3 --> E5
    E4 --> E5
    E5 --> E6
    E5 --> E7
    
    %% Canonical Request 流
    A5 --> F1
    A7 --> F1
    D2 --> F1
    E6 --> F1
    E7 --> F1
    C2 --> F1
    F1 --> F2
    F2 --> F3
    F3 --> F4
    
    %% String To Sign 流
    B2 --> G1
    B3 --> G2
    A3 --> G2
    A4 --> G2
    G2 --> G1
    F4 --> G1
    G1 --> G3
    
    %% 密钥派生流
    A2 --> H1
    B3 --> H1
    H1 --> H2
    A3 --> H3
    H2 --> H3
    H3 --> H4
    A4 --> H5
    H4 --> H5
    H5 --> H6
    H6 --> H7
    H7 --> H8
    
    %% 最终签名流
    G3 --> I1
    H8 --> I1
    I1 --> I2
    
    %% Authorization 流
    A1 --> J1
    G2 --> J1
    E6 --> J1
    I2 --> J1
    J1 --> J2
    
    %% 样式
    classDef dataNode fill:#e3f2fd,stroke:#2196f3,stroke-width:2px,color:#1565c0;
    classDef processNode fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#e65100;
    classDef resultNode fill:#e8f5e8,stroke:#4caf50,stroke-width:2px,color:#2e7d32;
    
    class A1,A2,A3,A4,A5,A6,A7,A8,B2,B3,C2,D2,E2,E3,E4,E6,E7,F2,F4,G2,G3,H2,H4,H6,H8,I2,J2 dataNode;
    class B1,C1,D1,E1,E5,F1,F3,G1,H1,H3,H5,H7,I1,J1 processNode;
            `;
            
            // 存储节点详细信息
            nodeDetails = {
                // 输入参数节点
                A1: {
                    title: 'Access Key',
                    content: `完整的Access Key:\n${data.accessKey || '[未提供]'}`
                },
                A2: {
                    title: 'Secret Key',
                    content: `Secret Key: [出于安全考虑不显示完整内容]\n长度: ${data.secretKey ? data.secretKey.length + ' 字符' : '未提供'}`
                },
                A3: {
                    title: 'Region 参数',
                    content: `Region: ${data.region}\n用途: 指定服务的地理区域`
                },
                A4: {
                    title: 'Service 参数', 
                    content: `Service: ${data.service}\n用途: 指定要访问的服务类型`
                },
                A5: {
                    title: 'HTTP Method',
                    content: `HTTP Method: ${data.method}\n支持的方法: GET, POST, PUT, DELETE, HEAD`
                },
                A6: {
                    title: 'Host 参数',
                    content: `Host: ${data.host}\n用途: 目标服务器地址`
                },
                A7: {
                    title: 'Path 参数',
                    content: `Path: ${data.path}\n用途: 请求的资源路径`
                },
                A8: {
                    title: 'Request Body',
                    content: `Request Body:\n${data.requestBody || '(空请求体)'}\n长度: ${(data.requestBody || '').length} 字节`
                },
                
                // 时间戳处理节点
                B1: {
                    title: '时间戳生成过程',
                    content: `时间戳类型: ${data.timestampType}\n原始时间: ${data.originalTime}\n处理规则: 将ISO时间转换为YYYYMMDDTHHMMSSZ格式`
                },
                B2: {
                    title: 'AMZ Date 时间戳',
                    content: `AMZ Date: ${data.amzDate}\n格式: YYYYMMDDTHHMMSSZ\n用途: 用于Headers和StringToSign`
                },
                B3: {
                    title: 'Date Stamp',
                    content: `Date Stamp: ${data.dateStamp}\n格式: YYYYMMDD\n用途: 用于密钥派生和凭证范围`
                },
                
                // Payload Hash 节点
                C1: {
                    title: 'SHA256 计算过程',
                    content: `输入: Request Body\n算法: SHA256\n输出: 64字符十六进制字符串\n\n如果Body为空则计算空字符串的SHA256\n如果是PUT操作且无法获取内容则使用'UNSIGNED-PAYLOAD'`
                },
                C2: {
                    title: 'Payload Hash 结果',
                    content: `Payload Hash: ${data.payloadHash}\n长度: ${data.payloadHash.length} 字符\n算法: SHA256\n用途: 用于Headers和CanonicalRequest`
                },
                
                // Query Parameters 节点
                D1: {
                    title: 'Query参数规范化过程',
                    content: `处理步骤:\n1. 收集所有查询参数\n2. 按参数名排序\n3. 对参数名和值进行URL编码\n4. 拼接为key=value格式`
                },
                D2: {
                    title: 'Canonical Query String',
                    content: `Canonical Query String: "${data.canonicalQueryString}"\n参数数量: ${data.paramCount}\n详情: ${data.paramDetails}`
                },
                
                // Headers 处理节点
                E1: {
                    title: 'Headers 收集过程',
                    content: `收集的Headers类型:\n1. host (必需)\n2. x-tos-date (必需) \n3. x-tos-content-sha256 (必需)\n4. x-tos-meta-* (可选)\n5. 其他需要签名的headers`
                },
                E2: {
                    title: 'Host Header',
                    content: `Header名: host\nHeader值: ${data.host}\n用途: 指定目标服务器\n必需: 是`
                },
                E3: {
                    title: 'Date Header',
                    content: `Header名: x-tos-date\nHeader值: ${data.amzDate}\n用途: 请求时间戳\n必需: 是`
                },
                E4: {
                    title: 'Content SHA256 Header',
                    content: `Header名: x-tos-content-sha256\nHeader值: ${data.payloadHash}\n用途: 请求体内容哈希\n必需: 是`
                },
                E5: {
                    title: 'Headers 排序过程',
                    content: `排序规则: 按Header名称字母顺序排序\n排序后顺序: ${data.signedHeaders.split(';').join(', ')}`
                },
                E6: {
                    title: 'Signed Headers',
                    content: `Signed Headers: ${data.signedHeaders}\n格式: 用分号分隔的小写header名列表\n用途: 告知哪些headers参与了签名`
                },
                E7: {
                    title: 'Canonical Headers',
                    content: `Canonical Headers:\n${data.canonicalHeaders}\n格式: 每行一个header，格式为"name:value\\n"\n用途: 构造CanonicalRequest的一部分`
                },
                
                // Canonical Request 节点
                F1: {
                    title: 'Canonical Request 构造过程',
                    content: `构造规则:\nMethod + "\\n" +\nURI + "\\n" +\nQueryString + "\\n" +\nCanonicalHeaders + "\\n" +\nSignedHeaders + "\\n" +\nPayloadHash`
                },
                F2: {
                    title: 'Canonical Request',
                    content: `Canonical Request:\n${data.canonicalRequest}\n\n长度: ${data.canonicalRequest.length} 字符`
                },
                F3: {
                    title: 'Canonical Request SHA256',
                    content: `算法: SHA256\n输入: Canonical Request 字符串\n输出: 64字符十六进制字符串`
                },
                F4: {
                    title: 'Request Hash',
                    content: `Request Hash: ${data.hashCR}\n长度: ${data.hashCR.length} 字符\n算法: SHA256\n用途: 构造StringToSign`
                },
                
                // String To Sign 节点
                G1: {
                    title: 'String To Sign 构造过程',
                    content: `构造规则:\nAlgorithm + "\\n" +\nTimestamp + "\\n" +\nCredentialScope + "\\n" +\nHashedCanonicalRequest`
                },
                G2: {
                    title: 'Credential Scope',
                    content: `Credential Scope: ${data.credentialScope}\n格式: YYYYMMDD/region/service/request\n组成: DateStamp/${data.region}/${data.service}/request`
                },
                G3: {
                    title: 'String To Sign',
                    content: `String To Sign:\n${data.stringToSign}\n\n长度: ${data.stringToSign.length} 字符`
                },
                
                // 密钥派生节点
                H1: {
                    title: 'kDate 计算过程',
                    content: `算法: HMAC-SHA256\n密钥: Secret Key\n消息: "${data.dateStamp}"\n输出: kDate (二进制密钥)`
                },
                H2: {
                    title: 'kDate 中间密钥',
                    content: `kDate: [中间密钥1]\n算法: HMAC-SHA256\n输入密钥: Secret Key\n消息: ${data.dateStamp}\n用途: 计算kRegion的密钥`
                },
                H3: {
                    title: 'kRegion 计算过程',
                    content: `算法: HMAC-SHA256\n密钥: kDate\n消息: "${data.region}"\n输出: kRegion (二进制密钥)`
                },
                H4: {
                    title: 'kRegion 中间密钥',
                    content: `kRegion: [中间密钥2]\n算法: HMAC-SHA256\n输入密钥: kDate\n消息: ${data.region}\n用途: 计算kService的密钥`
                },
                H5: {
                    title: 'kService 计算过程',
                    content: `算法: HMAC-SHA256\n密钥: kRegion\n消息: "${data.service}"\n输出: kService (二进制密钥)`
                },
                H6: {
                    title: 'kService 中间密钥',
                    content: `kService: [中间密钥3]\n算法: HMAC-SHA256\n输入密钥: kRegion\n消息: ${data.service}\n用途: 计算kSigning的密钥`
                },
                H7: {
                    title: 'kSigning 计算过程',
                    content: `算法: HMAC-SHA256\n密钥: kService\n消息: "request"\n输出: kSigning (最终签名密钥)`
                },
                H8: {
                    title: 'kSigning 最终密钥',
                    content: `kSigning: ${data.kSigning}\n长度: 64字符 (32字节十六进制)\n算法: HMAC-SHA256\n输入密钥: kService\n消息: "request"\n用途: 计算最终签名`
                },
                
                // 最终签名节点
                I1: {
                    title: '最终签名计算过程',
                    content: `算法: HMAC-SHA256\n密钥: kSigning\n消息: String To Sign\n输出: 最终签名 (64字符十六进制)`
                },
                I2: {
                    title: '最终签名结果',
                    content: `Final Signature: ${data.signature}\n长度: ${data.signature.length} 字符\n算法: HMAC-SHA256\n输入密钥: kSigning\n消息: String To Sign\n用途: 构造Authorization Header`
                },
                
                // Authorization Header 节点
                J1: {
                    title: 'Authorization 构造过程',
                    content: `格式: Algorithm Credential=AccessKey/CredentialScope, SignedHeaders=headers, Signature=signature\n\n组成部分:\n- Algorithm: ${data.algorithm}\n- Credential: ${data.accessKey}/${data.credentialScope}\n- SignedHeaders: ${data.signedHeaders}\n- Signature: ${data.signature}`
                },
                J2: {
                    title: 'Authorization Header',
                    content: `Authorization Header:\n${data.authHeader}\n\n长度: ${data.authHeader.length} 字符\n用途: HTTP请求的Authorization头部`
                }
            };
            
            return flowchartDefinition;
        }

        // 显示节点详细信息
        function showDetails(nodeId) {
            const details = nodeDetails[nodeId];
            if (details) {
                document.getElementById('node-content').innerHTML = 
                    `<h4>${details.title}</h4><pre>${details.content}</pre>`;
                document.getElementById('node-details').style.display = 'block';
            }
        }

        // 渲染流程图
        async function renderFlowchart(data) {
            try {
                if (typeof mermaid === 'undefined') {
                    throw new Error('Mermaid library not loaded');
                }
                
                chartId++;
                const currentChartId = `mermaid-chart-${chartId}`;
                const flowchartDef = generateFlowchart(data);
                const element = document.getElementById('signature-flowchart');
                
                // 清空之前的内容
                element.innerHTML = `<div id="${currentChartId}" class="mermaid">${flowchartDef}</div>`;
                
                // 使用 Mermaid 渲染
                const { svg } = await mermaid.render(currentChartId + '-svg', flowchartDef);
                element.innerHTML = svg;
                
                // 添加点击事件监听器 - 增加延迟确保DOM完全加载
                setTimeout(() => {
                    addClickListeners();
                }, 500);
            } catch (error) {
                console.error('Mermaid rendering error:', error);
                // 降级处理：显示文本版本
                const element = document.getElementById('signature-flowchart');
                element.innerHTML = `
                    <div style="text-align: left; background: var(--titanium-background); padding: 20px; border-radius: 4px;">
                        <p><strong>流程图渲染失败，显示文本版本：</strong></p>
                        <div style="font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', Monaco, monospace; white-space: pre-line; color: var(--titanium-text);">
                            1. 🔧 基础参数: Method=${data.method}, Host=${data.host}, Path=${data.path}
                            2. ⏰ 时间戳处理: ${data.amzDate}
                            3. 📝 Payload Hash: ${data.payloadHash}
                            4. 🔍 Query Parameters: ${data.canonicalQueryString}
                            5. 📋 Headers 处理: ${data.signedHeaders}
                            6. 📄 Canonical Request: 已构造
                            7. 🔐 String To Sign: 已构造
                            8. 🔑 密钥派生: kSigning=${data.kSigning}
                            9. ✅ 最终签名: ${data.signature}
                            10. 📤 Authorization Header: 已生成
                        </div>
                        <p style="margin-top: 15px;"><small>点击右侧详细输出查看完整信息</small></p>
                    </div>
                `;
            }
        }

        // 添加点击事件监听器
        function addClickListeners() {
            console.log('添加点击事件监听器');
            const container = document.getElementById('signature-flowchart');
            
            if (!container) {
                console.error('未找到流程图容器');
                return;
            }
            
            // 移除之前的事件监听器，确保不重复绑定
            const existingHandler = container._clickHandler;
            if (existingHandler) {
                container.removeEventListener('click', existingHandler);
                console.log('移除了之前的事件监听器');
            }
            
            // 创建新的处理函数并保存引用
            const newHandler = (event) => handleNodeClick(event);
            container._clickHandler = newHandler;
            
            // 添加新的事件监听器
            container.addEventListener('click', newHandler);
            
            // 查找SVG内的所有节点并添加调试信息
            setTimeout(() => {
                const svgNodes = container.querySelectorAll('g.node, g.flowchart-node, rect, text, g');
                console.log(`找到 ${svgNodes.length} 个可能的节点元素`);
                
                // 为每个节点添加调试样式
                svgNodes.forEach((node, index) => {
                    if (node.textContent && node.textContent.trim()) {
                        node.style.cursor = 'pointer';
                        console.log(`节点 ${index}:`, node.tagName, node.textContent.substring(0, 50));
                    }
                });
            }, 100);
            
            console.log('新的事件监听器已添加到容器');
        }
        
        function handleNodeClick(event) {
            console.log('点击事件触发', event.target);
            console.log('点击位置:', event.clientX, event.clientY);
            
            // 查找最近的节点元素
            let targetNode = event.target;
            let nodeId = null;
            
            // 获取目标节点及其相关节点的文本内容，支持多层级查找
            let nodeText = targetNode.textContent || '';
            let parentText = '';
            let grandparentText = '';
            
            // 查找父节点和祖父节点文本（限制查找范围）
            let parent = targetNode.parentElement;
            if (parent && parent.tagName !== 'svg') {
                parentText = parent.textContent || '';
                
                // 对于 polygon 等图形元素，需要查找更上层的文本
                let grandparent = parent.parentElement;
                if (grandparent && grandparent.tagName !== 'svg') {
                    grandparentText = grandparent.textContent || '';
                }
            }
            
            // 智能选择用于匹配的文本，优先选择最合适长度的文本
            let textToMatch = '';
            let candidateTexts = [nodeText, parentText, grandparentText].filter(text => text.length > 0);
            
            // 选择长度适中且包含有效信息的文本
            for (let candidate of candidateTexts) {
                if (candidate.length > 0 && candidate.length <= 200) {
                    // 如果包含关键词，优先使用
                    if (candidate.includes('生成时间戳') || candidate.includes('计算 SHA256') || 
                        candidate.includes('规范化查询参数') || candidate.includes('收集 Headers') ||
                        candidate.includes('构造') || candidate.includes('HMAC-SHA256') ||
                        candidate.includes('Access Key') || candidate.includes('Secret Key') ||
                        candidate.includes('Region') || candidate.includes('Service') ||
                        candidate.includes('HTTP Method') || candidate.includes('Host') ||
                        candidate.includes('Path') || candidate.includes('Request Body') ||
                        candidate.includes('AMZ Date') || candidate.includes('Date Stamp') ||
                        candidate.includes('Payload Hash') || candidate.includes('Canonical') ||
                        candidate.includes('String To Sign') || candidate.includes('Authorization') ||
                        candidate.includes('Final Signature') || candidate.includes('kDate') ||
                        candidate.includes('kRegion') || candidate.includes('kService') ||
                        candidate.includes('kSigning')) {
                        textToMatch = candidate;
                        break;
                    }
                }
            }
            
            // 如果没有找到合适的文本，使用最短的非空文本
            if (!textToMatch && candidateTexts.length > 0) {
                textToMatch = candidateTexts.reduce((shortest, current) => 
                    current.length < shortest.length ? current : shortest
                );
            }
            
            // 如果文本太长，截取前面部分
            if (textToMatch.length > 100) {
                textToMatch = textToMatch.substring(0, 100);
            }
            
            console.log('用于匹配的文本内容:', textToMatch);
            console.log('目标元素:', targetNode.tagName, targetNode.className);
            console.log('父元素:', parent ? parent.tagName : 'none', parent ? parent.className : 'none');
            
            // 更精确的文本匹配 - 使用更严格的匹配条件
            // 输入参数节点
            if (textToMatch === 'Access Key' || (textToMatch.includes('Access Key') && textToMatch.length < 50)) {
                nodeId = 'A1';
            } else if (textToMatch === 'Secret Key' || (textToMatch.includes('Secret Key') && textToMatch.includes('[已提供]'))) {
                nodeId = 'A2';
            } else if ((textToMatch.includes('Region') && !textToMatch.includes('kRegion')) && textToMatch.length < 50) {
                nodeId = 'A3';
            } else if ((textToMatch.includes('Service') && !textToMatch.includes('kService')) && textToMatch.length < 50) {
                nodeId = 'A4';
            } else if (textToMatch.includes('HTTP Method') && textToMatch.length < 50) {
                nodeId = 'A5';
            } else if ((textToMatch.includes('Host') && !textToMatch.includes('Header')) && textToMatch.length < 50) {
                nodeId = 'A6';
            } else if (textToMatch.includes('Path') && textToMatch.length < 50) {
                nodeId = 'A7';
            } else if (textToMatch.includes('Request Body') && textToMatch.length < 50) {
                nodeId = 'A8';
            }
            
            // 时间戳节点
            else if (textToMatch.includes('生成时间戳') && textToMatch.length < 50) {
                nodeId = 'B1';
            } else if (textToMatch.includes('AMZ Date') && textToMatch.length < 50) {
                nodeId = 'B2';
            } else if (textToMatch.includes('Date Stamp') && textToMatch.length < 50) {
                nodeId = 'B3';
            }
            
            // Payload Hash 节点
            else if (textToMatch.includes('计算 SHA256') && textToMatch.length < 50) {
                nodeId = 'C1';
            } else if (textToMatch.includes('Payload Hash') && textToMatch.length < 50) {
                nodeId = 'C2';
            }
            
            // Query 节点
            else if (textToMatch.includes('规范化查询参数') && textToMatch.length < 50) {
                nodeId = 'D1';
            } else if (textToMatch.includes('Canonical Query') && textToMatch.length < 50) {
                nodeId = 'D2';
            }
            
            // Headers 节点
            else if (textToMatch.includes('收集 Headers') && textToMatch.length < 50) {
                nodeId = 'E1';
            } else if (textToMatch.includes('Host Header') && textToMatch.length < 80) {
                nodeId = 'E2';
            } else if (textToMatch.includes('Date Header') && textToMatch.length < 80) {
                nodeId = 'E3';
            } else if (textToMatch.includes('Content Header') && textToMatch.length < 80) {
                nodeId = 'E4';
            } else if (textToMatch.includes('排序 Headers') && textToMatch.length < 50) {
                nodeId = 'E5';
            } else if (textToMatch.includes('Signed Headers') && textToMatch.length < 100) {
                nodeId = 'E6';
            } else if (textToMatch.includes('Canonical Headers') && textToMatch.includes('headers') && textToMatch.length < 100) {
                nodeId = 'E7';
            }
            
            // Canonical Request 节点
            else if (textToMatch.includes('构造 Canonical Request') && textToMatch.length < 50) {
                nodeId = 'F1';
            } else if (textToMatch.includes('Canonical Request') && textToMatch.includes('[Method') && textToMatch.length < 100) {
                nodeId = 'F2';
            } else if (textToMatch.includes('SHA256 Hash') && textToMatch.length < 50) {
                nodeId = 'F3';
            } else if (textToMatch.includes('Request Hash') && textToMatch.length < 50) {
                nodeId = 'F4';
            }
            
            // String To Sign 节点
            else if (textToMatch.includes('构造 String To Sign') && textToMatch.length < 50) {
                nodeId = 'G1';
            } else if (textToMatch.includes('Credential Scope') && textToMatch.length < 100) {
                nodeId = 'G2';
            } else if (textToMatch.includes('String To Sign') && textToMatch.includes('[Algorithm') && textToMatch.length < 100) {
                nodeId = 'G3';
            }
            
            // 密钥派生节点
            else if (textToMatch.includes('HMAC-SHA256') && textToMatch.includes('DateStamp') && textToMatch.length < 100) {
                nodeId = 'H1';
            } else if (textToMatch.includes('kDate') && textToMatch.includes('[中间密钥1]') && textToMatch.length < 50) {
                nodeId = 'H2';
            } else if (textToMatch.includes('HMAC-SHA256') && textToMatch.includes('Region') && !textToMatch.includes('DateStamp') && textToMatch.length < 100) {
                nodeId = 'H3';
            } else if (textToMatch.includes('kRegion') && textToMatch.includes('[中间密钥2]') && textToMatch.length < 50) {
                nodeId = 'H4';
            } else if (textToMatch.includes('HMAC-SHA256') && textToMatch.includes('Service') && !textToMatch.includes('Region') && textToMatch.length < 100) {
                nodeId = 'H5';
            } else if (textToMatch.includes('kService') && textToMatch.includes('[中间密钥3]') && textToMatch.length < 50) {
                nodeId = 'H6';
            } else if (textToMatch.includes("'request'") && textToMatch.length < 100) {
                nodeId = 'H7';
            } else if (textToMatch.includes('kSigning') && !textToMatch.includes('StringToSign') && textToMatch.length < 50) {
                nodeId = 'H8';
            }
            
            // 最终签名节点
            else if (textToMatch.includes('HMAC-SHA256') && textToMatch.includes('StringToSign') && textToMatch.length < 100) {
                nodeId = 'I1';
            } else if (textToMatch.includes('Final Signature') && textToMatch.length < 50) {
                nodeId = 'I2';
            }
            
            // Authorization 节点
            else if (textToMatch.includes('构造 Authorization') && textToMatch.length < 50) {
                nodeId = 'J1';
            } else if (textToMatch.includes('Authorization Header') && textToMatch.includes('TOS4') && textToMatch.length < 100) {
                nodeId = 'J2';
            }
            
            if (nodeId) {
                console.log('匹配到节点ID:', nodeId);
                showDetails(nodeId);
                
                // 添加视觉反馈
                const nodeDetailsDiv = document.getElementById('node-details');
                if (nodeDetailsDiv) {
                    nodeDetailsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            } else {
                console.log('未找到匹配的节点');
                console.log('节点文本:', nodeText);
                console.log('父节点文本:', parentText);
                console.log('祖父节点文本:', grandparentText);
                console.log('用于匹配的文本:', textToMatch);
                
                // 显示用户友好的提示信息，不显示技术调试细节
                document.getElementById('node-content').innerHTML = 
                    `<h4>节点信息</h4><div style="padding: 10px; background: #f8f9fa; border-radius: 4px; color: #6c757d;">
                        <p>👆 请点击流程图中的具体节点（矩形或菱形框）查看详细信息</p>
                        <p>💡 提示：</p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>矩形框代表数据或结果</li>
                            <li>菱形框代表处理过程</li>
                            <li>点击不同的节点可以查看该步骤的详细说明</li>
                        </ul>
                    </div>`;
                document.getElementById('node-details').style.display = 'block';
            }
            
            // 不要阻止事件传播，让点击事件能够继续工作
            // event.preventDefault();
            // event.stopPropagation();
        }
        function addParam() {
            const container = document.getElementById('queryParams');
            const paramRow = document.createElement('div');
            paramRow.className = 'param-row';
            paramRow.innerHTML = `
                <input type="text" placeholder="Key (可选)" class="param-key">
                <input type="text" placeholder="Value (可选)" class="param-value">
                <button type="button" class="remove-btn" onclick="removeParam(this)">删除</button>
            `;
            container.appendChild(paramRow);
        }

        function removeParam(button) {
            button.parentElement.remove();
        }

        function addHeader() {
            const container = document.getElementById('customHeaders');
            const headerRow = document.createElement('div');
            headerRow.className = 'param-row';
            headerRow.innerHTML = `
                <input type="text" placeholder="Header Name (如: x-tos-meta-example)" class="header-key">
                <input type="text" placeholder="Header Value" class="header-value">
                <button type="button" class="remove-btn" onclick="removeHeader(this)">删除</button>
            `;
            container.appendChild(headerRow);
        }

        function removeHeader(button) {
            button.parentElement.remove();
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.style.display = 'none';
        }

        function processHost(hostInput) {
            let originalHost = hostInput.trim();
            let processedHost = originalHost;
            let changes = [];

            // 移除 http:// 或 https:// 前缀
            if (processedHost.startsWith('http://')) {
                processedHost = processedHost.substring(7);
                changes.push('移除了 http:// 前缀');
            } else if (processedHost.startsWith('https://')) {
                processedHost = processedHost.substring(8);
                changes.push('移除了 https:// 前缀');
            }

            // 移除尾部的 / 
            if (processedHost.endsWith('/')) {
                processedHost = processedHost.slice(0, -1);
                changes.push('移除了尾部的 /');
            }

            return { processedHost, changes, originalHost };
        }

        function toggleTimestampInput() {
            const timestampType = document.getElementById('timestampType').value;
            const datetimeInput = document.getElementById('datetimeInput');
            const directInput = document.getElementById('directInput');
            
            datetimeInput.style.display = 'none';
            directInput.style.display = 'none';
            
            if (timestampType === 'datetime') {
                datetimeInput.style.display = 'block';
            } else if (timestampType === 'direct') {
                directInput.style.display = 'block';
            }
        }

        async function calculateSignature() {
            // 隐藏之前的通知
            hideNotification();
            
            const accessKey = document.getElementById('accessKey').value;
            const secretKey = document.getElementById('secretKey').value;
            const region = document.getElementById('region').value;
            const service = document.getElementById('service').value;
            const method = document.getElementById('method').value.toUpperCase();
            const hostInput = document.getElementById('host').value;
            const canonicalUri = document.getElementById('path').value || '/';
            const requestBody = document.getElementById('requestBody').value || '';
            
            // 调试信息：显示获取到的requestBody
            console.log('▶ 原始获取的requestBody:', requestBody);
            console.log('▶ 当前method:', method);
            
            // 处理 Host 输入
            const { processedHost: host, changes } = processHost(hostInput);
            
            // 如果有变更，显示通知
            if (changes.length > 0) {
                showNotification(`Host 已自动处理: ${changes.join(', ')} (原始: ${hostInput} → 处理后: ${host})`);
            }
            
            // 处理时间戳输入
            const timestampType = document.getElementById('timestampType').value;
            let targetDate;
            let amzDate;
            
            if (timestampType === 'direct') {
                const directTimestamp = document.getElementById('directTimestamp').value;
                if (directTimestamp && /^[0-9]{8}T[0-9]{6}Z$/.test(directTimestamp)) {
                    amzDate = directTimestamp;
                    // 从TOS格式转换为Date对象用于显示
                    const year = directTimestamp.substring(0, 4);
                    const month = directTimestamp.substring(4, 6);
                    const day = directTimestamp.substring(6, 8);
                    const hour = directTimestamp.substring(9, 11);
                    const minute = directTimestamp.substring(11, 13);
                    const second = directTimestamp.substring(13, 15);
                    targetDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}Z`);
                } else {
                    alert('请输入正确的TOS时间戳格式，如: 20250812T142648Z');
                    return;
                }
            } else if (timestampType === 'datetime') {
                const customTimestamp = document.getElementById('customTimestamp').value;
                if (customTimestamp) {
                    targetDate = new Date(customTimestamp);
                    amzDate = targetDate.toISOString().replace(/[:-]|\.\d{3}/g, "");
                } else {
                    alert('请选择日期时间');
                    return;
                }
            } else {
                // 使用当前时间
                targetDate = new Date();
                amzDate = targetDate.toISOString().replace(/[:-]|\.\d{3}/g, "");
            }

            const dateStamp = amzDate.substr(0, 8);

            const paramRows = document.querySelectorAll('.param-row');
            const params = [];
            paramRows.forEach(row => {
                const keyInput = row.querySelector('.param-key');
                const valueInput = row.querySelector('.param-value');
                if (keyInput && valueInput) {
                    const key = keyInput.value;
                    const value = valueInput.value;
                    if (key) {
                        params.push({ key, value: value || '' });
                    }
                }
            });

            params.sort((a, b) => a.key.localeCompare(b.key));

            const canonicalQueryString = params
                .map(p => `${encodeURIComponent(p.key)}=${encodeURIComponent(p.value)}`)
                .join('&');

            // 收集自定义 headers
            const headerRows = document.querySelectorAll('#customHeaders .param-row');
            const customHeaders = [];
            headerRows.forEach(row => {
                const keyInput = row.querySelector('.header-key');
                const valueInput = row.querySelector('.header-value');
                if (keyInput && valueInput) {
                    const key = keyInput.value;
                    const value = valueInput.value;
                    if (key && value) {
                        customHeaders.push({ key: key.trim(), value: value.trim() });
                    }
                }
            });

            let payloadHash;
            
            if (requestBody && method !== 'GET' && method !== 'HEAD') {
                // 直接使用原始的请求体内容计算hash，保持用户输入的格式
                // 这样可以确保hash值与实际发送的数据一致
                payloadHash = CryptoJS.SHA256(requestBody).toString(CryptoJS.enc.Hex);
            } else if (method === 'PUT' && !requestBody) {
                payloadHash = 'UNSIGNED-PAYLOAD';
            } else {
                payloadHash = CryptoJS.SHA256("").toString(CryptoJS.enc.Hex);
            }

            // 构造所有需要签名的 headers
            const allHeaders = [
                { key: 'host', value: host },
                { key: 'x-tos-date', value: amzDate },
                { key: 'x-tos-content-sha256', value: payloadHash }
            ];

            // 添加自定义 headers（只包含符合 TOS 要求的 headers）
            customHeaders.forEach(header => {
                const name = header.key.toLowerCase();
                // 包含 x-tos-meta-* headers 和其他需要签名的 headers
                if (name.startsWith("x-tos-meta-") || 
                    ["authorization", "content-type", "content-md5"].includes(name)) {
                    allHeaders.push(header);
                }
            });

            console.log("▶ Web版本 - All headers before sort:", allHeaders.map(h => `${h.key}: ${h.value}`));

            // 按 header 名称排序
            allHeaders.sort((a, b) => 
                a.key.toLowerCase().localeCompare(b.key.toLowerCase())
            );

            console.log("▶ Web版本 - All headers after sort:", allHeaders.map(h => `${h.key}: ${h.value}`));

            // 构造 canonical headers 字符串
            const canonicalHeaders = allHeaders
                .map(h => `${h.key.toLowerCase()}:${h.value.trim()}\n`)
                .join("");

            // 构造 signed headers 列表
            const signedHeaders = allHeaders
                .map(h => h.key.toLowerCase())
                .join(";");

            console.log("▶ Web版本 - canonicalHeaders:\\n", JSON.stringify(canonicalHeaders));
            console.log("▶ Web版本 - signedHeaders:", signedHeaders);

            const canonicalRequest = [
                method,
                canonicalUri,
                canonicalQueryString,
                canonicalHeaders,
                signedHeaders,
                payloadHash
            ].join("\n");

            console.log("▶ Web版本 - method:", method);
            console.log("▶ Web版本 - canonicalUri:", canonicalUri);
            console.log("▶ Web版本 - canonicalQueryString:", canonicalQueryString);
            console.log("▶ Web版本 - payloadHash:", payloadHash);
            console.log("▶ Web版本 - canonicalRequest:\\n", canonicalRequest);

            const algorithm = "TOS4-HMAC-SHA256";
            const credentialScope = `${dateStamp}/${region}/${service}/request`;
            const hashCR = CryptoJS.SHA256(canonicalRequest).toString(CryptoJS.enc.Hex);
            const stringToSign = [
                algorithm,
                amzDate,
                credentialScope,
                hashCR
            ].join("\n");

            console.log("▶ Web版本 - algorithm:", algorithm);
            console.log("▶ Web版本 - credentialScope:", credentialScope);
            console.log("▶ Web版本 - hashCR:", hashCR);
            console.log("▶ Web版本 - stringToSign:\\n", stringToSign);

            const kDate = CryptoJS.HmacSHA256(dateStamp, secretKey);
            const kRegion = CryptoJS.HmacSHA256(region, kDate);
            const kService = CryptoJS.HmacSHA256(service, kRegion);
            const kSigning = CryptoJS.HmacSHA256("request", kService);

            const signature = CryptoJS.HmacSHA256(stringToSign, kSigning).toString(CryptoJS.enc.Hex);

            console.log("▶ Web版本 - kSigning (hex):", kSigning.toString(CryptoJS.enc.Hex));
            console.log("▶ Web版本 - signature:", signature);

            const authHeader = 
                `${algorithm} ` +
                `Credential=${accessKey}/${credentialScope}, ` +
                `SignedHeaders=${signedHeaders}, ` +
                `Signature=${signature}`;

            console.log("▶ Web版本 - Authorization:", authHeader);

            // 填充输出信息
            document.getElementById('basicParamsOutput').textContent = 
                `HTTP Method: ${method}\nHost: ${host}${hostInput !== host ? ` (原始: ${hostInput})` : ''}\nPath: ${canonicalUri}\nRegion: ${region}\nService: ${service}\nAccess Key: ${accessKey}`;
                
            document.getElementById('timestampOutput').textContent = 
                `时间戳类型: ${timestampType === 'current' ? '当前时间' : timestampType === 'datetime' ? '选择时间' : 'TOS格式'}\n原始时间: ${targetDate.toISOString()}\nTOS时间戳: ${amzDate}\nDate Stamp: ${dateStamp}`;

            document.getElementById('payloadHashOutput').textContent = 
                `Request Body: ${requestBody ? `"${requestBody}"` : '(空)'}\n长度: ${requestBody ? requestBody.length : 0} 字符\nPayload Hash算法: SHA256\nPayload Hash: ${payloadHash}\n\n注意: Hash计算使用原始输入格式，保持换行和空格`;

            document.getElementById('queryParamsOutput').textContent = 
                `参数数量: ${params.length}\n参数详情: ${params.length > 0 ? params.map(p => `${p.key}=${p.value}`).join(', ') : '(无参数)'}\nCanonical Query String: "${canonicalQueryString}"`;
                
            document.getElementById('headersToSignOutput').textContent = 
                `需签名Headers数量: ${allHeaders.length}\nHeaders列表:\n${allHeaders.map(h => `  ${h.key}: ${h.value}`).join('\n')}\n\nSigned Headers: ${signedHeaders}\n\nCanonical Headers:\n${canonicalHeaders}`;
                
            document.getElementById('canonicalRequestOutput').textContent = canonicalRequest;
            
            document.getElementById('stringToSignOutput').textContent = 
                `算法: ${algorithm}\n时间戳: ${amzDate}\n凭证范围: ${credentialScope}\nCanonical Request Hash: ${hashCR}\n\nString To Sign:\n${stringToSign}`;

            document.getElementById('keyDerivationOutput').textContent = 
                `1. kDate = HMAC-SHA256("${dateStamp}", SecretKey)\n2. kRegion = HMAC-SHA256("${region}", kDate)\n3. kService = HMAC-SHA256("${service}", kRegion)\n4. kSigning = HMAC-SHA256("request", kService)\n\nkSigning (Hex): ${kSigning.toString(CryptoJS.enc.Hex)}`;

            document.getElementById('signatureOutput').textContent = 
                `签名算法: HMAC-SHA256\n签名输入: String To Sign\n签名密钥: kSigning\n\n最终签名: ${signature}`;

            document.getElementById('authHeaderOutput').textContent = authHeader;

            // 生成 cURL 请求
            const curlRequest = generateCurlRequest({
                method,
                host,
                path: canonicalUri,
                requestBody,
                authHeader,
                amzDate,
                payloadHash,
                customHeaders,
                canonicalQueryString
            });
            
            document.getElementById('curlRequestOutput').textContent = curlRequest;

            // 准备流程图数据
            const flowchartData = {
                accessKey,
                secretKey,
                method,
                host,
                path: canonicalUri,
                region,
                service,
                timestampType: timestampType === 'current' ? '当前时间' : timestampType === 'datetime' ? '选择时间' : 'TOS格式',
                originalTime: targetDate.toISOString(),
                amzDate,
                dateStamp,
                requestBody: requestBody || '(空)',
                payloadHash,
                paramCount: params.length,
                paramDetails: params.length > 0 ? params.map(p => `${p.key}=${p.value}`).join(', ') : '(无参数)',
                canonicalQueryString,
                headerCount: allHeaders.length,
                signedHeaders,
                canonicalHeaders,
                canonicalRequest,
                algorithm,
                credentialScope,
                hashCR,
                stringToSign,
                kSigning: kSigning.toString(CryptoJS.enc.Hex),
                signature,
                authHeader
            };

            // 渲染流程图
            await renderFlowchart(flowchartData);

            // 显示整个结果容器
            document.getElementById('results-panel').style.display = 'block';
            document.getElementById('flowchart-section').style.display = 'block';
        }

        // 生成 cURL 请求
        function generateCurlRequest(options) {
            const { method, host, path, requestBody, authHeader, amzDate, payloadHash, customHeaders, canonicalQueryString } = options;
            
            // 构建完整URL
            const protocol = 'https://';
            const fullUrl = protocol + host + path + (canonicalQueryString ? '?' + canonicalQueryString : '');
            
            // 构建cURL命令
            let curlCommand = `curl -X ${method} \\\n  "${fullUrl}"`;
            
            // 添加必需的headers
            curlCommand += ` \\\n  -H "Host: ${host}"`;
            curlCommand += ` \\\n  -H "Authorization: ${authHeader}"`;
            curlCommand += ` \\\n  -H "x-tos-date: ${amzDate}"`;
            curlCommand += ` \\\n  -H "x-tos-content-sha256: ${payloadHash}"`;
            
            // 添加自定义headers
            if (customHeaders && customHeaders.length > 0) {
                customHeaders.forEach(header => {
                    curlCommand += ` \\\n  -H "${header.key}: ${header.value}"`;
                });
            }
            
            // 添加Content-Type（如果有请求体）
            if (requestBody && method !== 'GET' && method !== 'HEAD') {
                // 检查是否已经有Content-Type header
                const hasContentType = customHeaders && customHeaders.some(h => 
                    h.key.toLowerCase() === 'content-type'
                );
                if (!hasContentType) {
                    curlCommand += ` \\\n  -H "Content-Type: application/json"`;
                }
                curlCommand += ` \\\n  -d '${requestBody}'`;
            }
            
            return curlCommand;
        }
        
        // 复制 cURL 命令到剪贴板
        function copyCurl() {
            const curlText = document.getElementById('curlRequestOutput').textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                // 使用现代剪贴板 API
                navigator.clipboard.writeText(curlText).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    console.error('复制失败:', err);
                    fallbackCopy(curlText);
                });
            } else {
                // 降级到传统方法
                fallbackCopy(curlText);
            }
        }
        
        // 降级复制方法
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                console.error('复制失败:', err);
                alert('复制失败，请手动选择并复制文本');
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        // 显示复制成功反馈
        function showCopySuccess() {
            const btn = document.getElementById('copyCurlBtn');
            const originalText = btn.textContent;
            btn.textContent = '已复制!';
            btn.style.backgroundColor = 'var(--aws-green)';
            btn.style.color = 'white';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.backgroundColor = '';
                btn.style.color = '';
            }, 2000);
        }

        // 处理Host输入的自动解析功能
        function processHostInput() {
            const hostInput = document.getElementById('host');
            const pathInput = document.getElementById('path');
            const infoDiv = document.getElementById('hostProcessInfo');
            
            let originalValue = hostInput.value;
            let processedValue = originalValue;
            let messages = [];
            
            // 如果输入为空，隐藏提示信息
            if (!originalValue.trim()) {
                infoDiv.style.display = 'none';
                return;
            }
            
            // 1. 去除空格、tab、回车等无效字符
            processedValue = processedValue.replace(/[\s\t\r\n]/g, '');
            if (processedValue !== originalValue) {
                messages.push('已清理无效空白字符');
            }
            
            // 2. 去除http/https前缀
            const httpRegex = /^https?:\/\//i;
            if (httpRegex.test(processedValue)) {
                processedValue = processedValue.replace(httpRegex, '');
                messages.push('已移除HTTP/HTTPS前缀');
            }
            
            // 3. 检查是否包含路径和查询参数
            let hasPathOrQuery = false;
            let queryStringFound = '';
            
            // 检查整个URL中是否包含查询参数
            const questionMarkIndex = processedValue.indexOf('?');
            if (questionMarkIndex !== -1) {
                queryStringFound = processedValue.substring(questionMarkIndex + 1);
                processedValue = processedValue.substring(0, questionMarkIndex);
            }
            
            const urlParts = processedValue.split('/');
            const hostPart = urlParts[0];
            
            if (urlParts.length > 1) {
                // 提取路径部分
                const pathPart = '/' + urlParts.slice(1).join('/');
                
                // 设置处理后的host
                processedValue = hostPart;
                hasPathOrQuery = true;
                
                // 自动填充路径
                if (pathPart && pathPart !== '/') {
                    pathInput.value = pathPart;
                    messages.push(`已自动填充Path: ${pathPart}`);
                } else {
                    // 如果路径是根路径，确保Path字段为'/'
                    pathInput.value = '/';
                }
            }
            
            // 处理查询参数 - 无论是否有路径，都要处理查询参数
            if (questionMarkIndex !== -1 || hasPathOrQuery) {
                if (queryStringFound) {
                    parseAndFillQueryParams(queryStringFound);
                    messages.push(`已自动填充Query参数: ${queryStringFound}`);
                } else {
                    // 如果检测到URL格式但没有query参数，清空现有参数
                    clearQueryParams();
                    messages.push('已清空Query参数');
                }
            }
            
            // 4. 去除尾部的斜杠（如果有）
            if (processedValue.endsWith('/')) {
                processedValue = processedValue.slice(0, -1);
                messages.push('已移除尾部斜杠');
            }
            
            // 更新Host输入框的值
            if (processedValue !== originalValue) {
                hostInput.value = processedValue;
            }
            
            // 显示处理信息
            if (messages.length > 0) {
                infoDiv.innerHTML = `
                    <button class="host-process-close" onclick="closeHostProcessInfo()" title="关闭">×</button>
                    <div class="original-url">原始输入: ${originalValue}</div>
                    <div class="process-details">✅ 已自动处理: ${messages.join(', ')}</div>
                `;
                infoDiv.style.display = 'block';
                // 不再自动隐藏提示，保持显示状态
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        // 解析并填充查询参数
        function parseAndFillQueryParams(queryString) {
            const container = document.getElementById('queryParams');
            
            // 清空现有的查询参数
            container.innerHTML = '';
            
            // 解析查询字符串
            const params = queryString.split('&');
            
            params.forEach(param => {
                const [key, value = ''] = param.split('=');
                if (key) {
                    // 创建新的参数行
                    const paramRow = document.createElement('div');
                    paramRow.className = 'param-row';
                    paramRow.innerHTML = `
                        <input class="form-input param-key" type="text" placeholder="参数名" value="${decodeURIComponent(key)}">
                        <input class="form-input param-value" type="text" placeholder="参数值" value="${decodeURIComponent(value)}">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeParam(this)">删除</button>
                    `;
                    container.appendChild(paramRow);
                }
            });
            
            // 如果没有参数或只有空参数，添加一个空行
            if (container.children.length === 0) {
                addEmptyParamRow();
            }
        }
        
        // 清空查询参数
        function clearQueryParams() {
            const container = document.getElementById('queryParams');
            container.innerHTML = '';
            addEmptyParamRow();
        }
        
        // 添加空的参数行
        function addEmptyParamRow() {
            const container = document.getElementById('queryParams');
            const paramRow = document.createElement('div');
            paramRow.className = 'param-row';
            paramRow.innerHTML = `
                <input class="form-input param-key" type="text" placeholder="参数名">
                <input class="form-input param-value" type="text" placeholder="参数值">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeParam(this)">删除</button>
            `;
            container.appendChild(paramRow);
        }

        // 关闭Host处理信息提示框
        function closeHostProcessInfo() {
            const infoDiv = document.getElementById('hostProcessInfo');
            infoDiv.style.display = 'none';
        }

        // 检查HTTP Method和Request Body的冲突
        function checkMethodBodyConflict() {
            const method = document.getElementById('method').value;
            const requestBody = document.getElementById('requestBody').value;
            const warningDiv = document.getElementById('methodBodyWarning');
            
            // 如果是GET或HEAD方法，且有Request Body内容，显示警告
            if ((method === 'GET' || method === 'HEAD') && requestBody.trim()) {
                warningDiv.style.display = 'block';
                if (method === 'HEAD') {
                    warningDiv.textContent = '⚠️ 通常是 POST 或 PUT Method 使用 Body，当前Method为 HEAD ，请仔细确认';
                } else {
                    warningDiv.textContent = '⚠️ 通常是 POST 或 PUT Method 使用 Body，当前Method为 GET ，请仔细确认';
                }
            } else {
                warningDiv.style.display = 'none';
            }
        }

        document.getElementById('signatureForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await calculateSignature();
        });
    </script>
</body>
</html>